{% include 'imports.html' %}
<script>
    const userAccessToken = cookie.get('user_access_token');
    const userRefreshToken = cookie.get('user_refresh_token');
    if (!userAccessToken && !userRefreshToken) {
        window.location.href = '/';
    }
</script>

<body>
    <div class="uk-text-bold uk-text-large uk-margin-large-left uk-margin-large-right uk-margin-top">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 class="uk-text-left" style="font-family: Comfortaa, sans-serif;font-weight: 700;">User Dashboard</h1>
            <button uk-tooltip="logout" class="uk-text-right" onclick="logoutUser()"
                style="font-family: Comfortaa, sans-serif;background-color: #ffd60a;padding: 6px;border-radius: 0;text-transform: none;color: #000;border: 2px solid #000;">
                <span uk-icon="user"></span>
            </button>
        </div>
    </div>
    <script>
        function logoutUser() {
            // Clear tokens and redirect to login page
            cookie.remove('user_access_token');
            cookie.remove('user_refresh_token');
            window.location.href = '/';
        }
    </script>
    <div class="uk-margin-large-bottom" style="height: 1.5px;background-color: #000;"></div>
    <br>
    <div class="uk-container">
        <div class="uk-grid-divider uk-child-width-expand@2" uk-grid>
            <div>
                <h3 style="font-family: Comfortaa, sans-serif;font-weight: 700;">Update Profile</h3>
                <form class="uk-form-stacked uk-width-1-1" id="updateForm" onsubmit="updateProfile(event)">
                    <div class="uk-margin">
                        <input class="uk-input" type="text" id="username" placeholder="Username">
                    </div>
                    <div class="uk-margin">
                        <input class="uk-input" type="email" id="email" placeholder="Email">
                    </div>
                    <div class="uk-margin">
                        <input class="uk-input" type="password" id="password" placeholder="Password">
                    </div>
                    <div class="uk-margin">
                        <button id="authBtn" class="uk-button uk-text-bold uk-button-primary uk-width-1-1">Update</button>
                    </div>
                </form>

                <script>
                    async function updateProfile(event) {
                        event.preventDefault();
                        
                        const userAccessToken = cookie.get('user_access_token');
                        if (!userAccessToken) {
                            window.location.href = '/';
                            return;
                        }

                        const userId = cookie.get('user_id');
                        const url = `/api/users/${userId}`;
                        const data = {
                            username: document.getElementById('username').value,
                            email: document.getElementById('email').value,
                            password: document.getElementById('password').value
                        };

                        try {
                            const response = await fetch(url, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userAccessToken}`
                                },
                                body: JSON.stringify(data)
                            });

                            if (response.ok) {
                                alert('Profile updated successfully');
                            } else {
                                alert('Failed to update profile');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('An error occurred while updating the profile');
                        }
                    }
                </script>
            </div>
            <div>
                <h3 style="font-family: Comfortaa, sans-serif;font-weight: 700;">Todos</h3>
                <table id="todos-table" class="uk-table uk-table-divider" style="border: 2px solid black;">
                    <thead>
                        <tr>
                            <th>Completed</th>
                            <th>Date Created</th>
                            <th>Id</th>
                            <th>User Id</th>
                            <th>Updated</th>
                            <th>Title</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>